{% extends "base.html" %}

{% block title %}Dashboard - Fund Management{% endblock %}

{% block content %}
<div class="row">
    <div class="col-12">
        <div class="d-flex justify-content-between align-items-center mb-4">
            <div>
                <h2 class="mb-0">{{ fund.name }}</h2>
                {% if fund.description %}
                <p class="text-muted mb-0">{{ fund.description }}</p>
                {% endif %}
                <p class="text-muted mb-0">Welcome, {{ user.full_name }}. View your installments and payment status below.</p>
            </div>
            <div>
                <a href="/funds" class="btn btn-secondary">Back to Funds</a>
            </div>
        </div>
    </div>
</div>

<!-- Fund Statistics Cards -->
<div class="row mb-4">
    <div class="col-md-6">
        <div class="card bg-primary text-white">
            <div class="card-body text-center">
                <h5>Fund Value</h5>
                <h3>â‚¹{{ "{:,.0f}".format(fund.total_amount) }}</h3>
            </div>
        </div>
    </div>
    <div class="col-md-6">
        <div class="card bg-success text-white">
            <div class="card-body text-center">
                <h5>Monthly Installment Paid</h5>
                <h3>â‚¹{{ "{:,.2f}".format(total_paid_installments) }}</h3>
            </div>
        </div>
    </div>
</div>

{% if user.role != "admin" and user not in fund.members %}
<!-- Join Fund Section for non-members -->
<div class="row mb-4">
    <div class="col-12">
        <div class="alert alert-info">
            <h5>Join This Fund</h5>
            <p>You are not a member of this fund yet. Click the button below to join and start making payments.</p>
            <form method="POST" action="/funds/{{ fund.id }}/join" class="d-inline">
                <button type="submit" class="btn btn-primary">Join This Fund</button>
            </form>
        </div>
    </div>
</div>
{% endif %}

<div class="row">
    <div class="col-12">
        {% for month in months %}
            {% if month.is_taken %}
            {% if month.monthly_payment_status == "verified" %}
            <div class="alert alert-info assigned-month-alert" role="alert" style="margin-bottom: 20px;">
                <h5 class="alert-heading">âœ… Payment Already Received</h5>
                <p class="mb-0"><strong>{{ month.month_name }}</strong> - You have already received â‚¹{{ "{:,.2f}".format(month.payment_amount) }} for this month!</p>
            </div>
            {% else %}
            <div class="alert alert-success assigned-month-alert" role="alert" style="margin-bottom: 20px;">
                <h5 class="alert-heading">ðŸŽ‰ Your Payment Month</h5>
                <p class="mb-0"><strong>{{ month.month_name }}</strong> - You will receive â‚¹{{ "{:,.2f}".format(month.payment_amount) }} for this month!</p>
            </div>
            {% endif %}
            {% endif %}
        {% endfor %}
    </div>
</div>

<div class="row mt-4">
    <div class="col-12">
        <div class="card">
            <div class="card-header bg-primary text-white">
                <h5 class="mb-0">Monthly Installments & Payments</h5>
            </div>
            <div class="card-body">
                <div class="table-responsive">
                    <table class="table table-striped table-hover" id="dashboard-table">
                        <thead>
                            <tr>
                                <th>Month</th>
                                <th>Monthly Installment</th>
                                <th>Monthly Payment</th>
                                <th>Installment Status</th>
                                <th>Payment Received Status</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for month in months %}
                            <tr class="{% if month.is_current_month %}table-warning{% elif month.is_taken %}table-success{% endif %}" data-month-id="{{ month.id }}">
                                <td>
                                    <strong>{{ month.month_name }}</strong>
                                    {% if user.role == "admin" %}
                                        {% if month.assigned_user_display %}
                                        <br><small class="text-muted" title="Assigned to {{ month.assigned_user_display.full_name or month.assigned_user_display.display_name }}">
                                            {% if month.assigned_user_id == user.id %}
                                            ðŸ‘¤ You
                                            {% else %}
                                            ðŸ‘¤ {{ month.assigned_user_display.display_name }}
                                            {% endif %}
                                        </small>
                                        {% else %}
                                        <br><small class="text-danger">ðŸ‘¤ Not Assigned</small>
                                        {% endif %}
                                    {% elif month.assigned_user_display and month.is_taken == false %}
                                        {# Regular users can see who took the month, but only alias/customer_id #}
                                        {% if month.assigned_user_display %}
                                        <br><small class="text-muted">
                                            {% if month.assigned_user_id == user.id %}
                                            ðŸ‘¤ You
                                            {% else %}
                                            ðŸ‘¤ {{ month.assigned_user_display.display_name }}
                                            {% endif %}
                                        </small>
                                        {% endif %}
                                    {% elif month.assigned_user_id == user.id %}
                                        {# Show "You" for the user's own assigned month #}
                                        <br><small class="text-muted">ðŸ‘¤ You</small>
                                    {% else %}
                                        {# Show "Not Assigned" in red for unassigned months #}
                                        <br><small class="text-danger">ðŸ‘¤ Not Assigned</small>
                                    {% endif %}
                                </td>
                                <td {% if user.role == "admin" %}class="editable" data-field="installment" data-month-id="{{ month.id }}"{% endif %}>
                                    <span class="{% if user.role == "admin" %}editable-value{% endif %}">â‚¹{{ "{:,.2f}".format(month.installment_amount) }}</span>
                                    {% if user.role == "admin" %}
                                    <input type="number" class="form-control form-control-sm d-none editable-input" 
                                           value="{{ month.installment_amount }}" step="0.01" min="0">
                                    {% endif %}
                                </td>
                                <td {% if user.role == "admin" %}class="editable" data-field="payment" data-month-id="{{ month.id }}"{% endif %}>
                                    <span class="{% if user.role == "admin" %}editable-value{% endif %}">â‚¹{{ "{:,.2f}".format(month.payment_amount) }}</span>
                                    {% if user.role == "admin" %}
                                    <input type="number" class="form-control form-control-sm d-none editable-input" 
                                           value="{{ month.payment_amount }}" step="0.01" min="0">
                                    {% endif %}
                                </td>
                                <td>
                                    {% if month.installment_payment_status == "verified" %}
                                    <span class="badge bg-success">Paid</span>
                                    {% elif month.installment_payment_status == "pending" %}
                                    <span class="badge bg-warning">Pending</span>
                                    {% elif month.installment_payment_status == "rejected" %}
                                    <span class="badge bg-danger">Rejected</span>
                                    {% else %}
                                    <span class="badge bg-danger">Not Paid</span>
                                    {% endif %}
                                </td>
                                <td style="max-width: 100px; word-wrap: break-word;">
                                    <div class="d-flex flex-column gap-1" style="font-size: 0.875rem;">
                                        {% if month.is_taken %}
                                        <div>
                                            {% if month.monthly_payment_status == "verified" %}
                                            <span class="badge bg-success">âœ“ Received</span>
                                            {% elif month.monthly_payment_status == "pending" %}
                                            <span class="badge bg-warning">Pending</span>
                                            {% elif month.monthly_payment_status == "rejected" %}
                                            <span class="badge bg-danger">Rejected</span>
                                            {% else %}
                                            <span class="badge bg-secondary">Not Received</span>
                                            {% endif %}
                                        </div>
                                        {% endif %}
                                        <div>
                                            <span class="badge {% if month.verified_installments_count == month.total_users %}bg-success{% elif month.verified_installments_count > 0 %}bg-warning{% else %}bg-danger{% endif %}">
                                                {{ month.verified_installments_count }}/{{ month.total_users }} paid
                                            </span>
                                        </div>
                                    </div>
                                </td>
                                <td>
                                    <div class="d-flex flex-column gap-1">
                                        {% if user.role == "admin" %}
                                            {# Admin can mark payment received for any month #}
                                            {% if not month.monthly_payment_status or month.monthly_payment_status == "rejected" %}
                                            <button class="btn btn-sm btn-primary mark-monthly-payment-received" 
                                                    data-month-id="{{ month.id }}"
                                                    data-payment-amount="{{ month.payment_amount }}">
                                                Mark â‚¹{{ "{:,.2f}".format(month.payment_amount) }} Received
                                            </button>
                                            {% endif %}
                                        {% elif month.is_taken and (not month.monthly_payment_status or month.monthly_payment_status == "rejected") %}
                                            {# Regular users can only mark their own assigned month #}
                                            <button class="btn btn-sm btn-primary mark-monthly-payment-received" 
                                                    data-month-id="{{ month.id }}"
                                                    data-payment-amount="{{ month.payment_amount }}">
                                                Mark â‚¹{{ "{:,.2f}".format(month.payment_amount) }} Received
                                            </button>
                                        {% endif %}
                                        {% if not month.installment_payment_status or month.installment_payment_status == "rejected" %}
                                        <button class="btn btn-sm btn-primary pay-installment-btn" 
                                                data-month-id="{{ month.id }}"
                                                data-installment-amount="{{ month.installment_amount }}">
                                            Pay Installment
                                        </button>
                                        {% endif %}
                                    </div>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                        <tfoot>
                            <tr class="table-info">
                                <td colspan="1"><strong>Total</strong></td>
                                <td><strong>â‚¹{{ "{:,.2f}".format(total_installment_amount) }}</strong></td>
                                <td></td>
                                <td></td>
                                <td></td>
                                <td></td>
                            </tr>
                        </tfoot>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="row mt-4">
    <div class="col-12">
        <div class="card bg-info text-white">
            <div class="card-body">
                <h5>How It Works</h5>
                <ul class="mb-0">
                    <li>Monthly installment should be done before the 10th of every month.</li>
                    <li>Monthly Payment will be paid on the 11th of every month or when all installments are paid.</li>
                    <li>10 members participate, each paying a monthly installment as shown in the table.</li>
                    <li>Each month, ONE member receives the Monthly Payment.</li>
                    <li>Members choose their preferred month on a first-come, first-served basis.</li>
                </ul>
            </div>
        </div>
    </div>
</div>

<!-- Pay Installment Modal -->
<div class="modal fade" id="payInstallmentModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Pay Installment</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="payInstallmentForm">
                    <input type="hidden" id="payInstallmentMonthId" name="month_id">
                    {% if user.role == "admin" %}
                    <div class="mb-3">
                        <label for="payInstallmentUsername" class="form-label">Username <span class="text-danger">*</span></label>
                        <select class="form-select" id="payInstallmentUsername" name="username" required>
                            <option value="">Select username</option>
                            {% for u in all_users %}
                            <option value="{{ u.username }}">{{ u.full_name }} ({{ u.username }})</option>
                            {% endfor %}
                        </select>
                        <small class="form-text text-muted">Select the user for whom you are adding this payment</small>
                    </div>
                    {% endif %}
                    <div class="mb-3">
                        <label for="payInstallmentAmount" class="form-label">Installment Amount</label>
                        <input type="text" class="form-control" id="payInstallmentAmount" readonly>
                    </div>
                    <div class="mb-3">
                        <label for="payInstallmentDate" class="form-label">Payment Date <span class="text-danger">*</span></label>
                        <input type="date" class="form-control" id="payInstallmentDate" name="payment_date" required>
                    </div>
                    <div class="mb-3">
                        <label for="payInstallmentTransactionId" class="form-label">Transaction ID / Reference</label>
                        <input type="text" class="form-control" id="payInstallmentTransactionId" name="transaction_id" placeholder="Enter transaction ID or reference number">
                    </div>
                    <div class="mb-3">
                        <label for="payInstallmentTransactionType" class="form-label">Transaction Type</label>
                        <select class="form-select" id="payInstallmentTransactionType" name="transaction_type">
                            <option value="">Select transaction type</option>
                            <option value="GPay">GPay</option>
                            <option value="Cash">Cash</option>
                            <option value="UPI">UPI</option>
                            <option value="Bank Transfer">Bank Transfer</option>
                            <option value="Cheque">Cheque</option>
                            <option value="Other">Other</option>
                        </select>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" onclick="submitPayment()">Submit Payment</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
// Submit payment function
async function submitPayment() {
    const form = document.getElementById('payInstallmentForm');
    const formData = new FormData(form);
    
    // Validate payment date
    const paymentDate = formData.get('payment_date');
    if (!paymentDate) {
        alert('Payment date is required!');
        return;
    }
    
    try {
        const response = await fetch('/api/user/payments', {
            method: 'POST',
            body: formData
        });
        
        const data = await response.json();
        
        if (response.ok) {
            alert('Payment submitted successfully! Waiting for admin verification.');
            // Close modal
            const modal = bootstrap.Modal.getInstance(document.getElementById('payInstallmentModal'));
            modal.hide();
            // Reload page
            location.reload();
        } else {
            alert('Error: ' + (data.detail || 'Failed to submit payment'));
        }
    } catch (error) {
        alert('Error: ' + error.message);
    }
}

document.addEventListener('DOMContentLoaded', function() {
    // Pay installment functionality
    const payInstallmentButtons = document.querySelectorAll('.pay-installment-btn');
    payInstallmentButtons.forEach(button => {
        button.addEventListener('click', function() {
            const monthId = this.dataset.monthId;
            const installmentAmount = parseFloat(this.dataset.installmentAmount);
            
            // Check if modal elements exist before accessing them
            const monthIdInput = document.getElementById('payInstallmentMonthId');
            const amountInput = document.getElementById('payInstallmentAmount');
            const dateInput = document.getElementById('payInstallmentDate');
            const transactionIdInput = document.getElementById('payInstallmentTransactionId');
            const transactionTypeInput = document.getElementById('payInstallmentTransactionType');
            const modalElement = document.getElementById('payInstallmentModal');
            
            if (!monthIdInput || !amountInput || !dateInput || !transactionIdInput || !transactionTypeInput || !modalElement) {
                console.error('Modal elements not found');
                alert('Error: Payment form not available. Please refresh the page.');
                return;
            }
            
            // Populate modal
            monthIdInput.value = monthId;
            amountInput.value = 'â‚¹' + installmentAmount.toLocaleString('en-IN', {minimumFractionDigits: 2, maximumFractionDigits: 2});
            
            // Reset form with today's date as default
            const today = new Date().toISOString().split('T')[0];
            dateInput.value = today;
            transactionIdInput.value = '';
            transactionTypeInput.value = '';
            
            // Reset username field for admin
            {% if user.role == "admin" %}
            const usernameInput = document.getElementById('payInstallmentUsername');
            if (usernameInput) {
                usernameInput.value = '';
            }
            {% endif %}
            
            // Show modal
            const modal = new bootstrap.Modal(modalElement);
            modal.show();
        });
    });
    
    // Mark monthly payment received functionality
    const markMonthlyPaymentButtons = document.querySelectorAll('.mark-monthly-payment-received');
    markMonthlyPaymentButtons.forEach(button => {
        button.addEventListener('click', async function() {
            const monthId = this.dataset.monthId;
            const paymentAmount = parseFloat(this.dataset.paymentAmount);
            
            if (!confirm(`Mark monthly payment of â‚¹${paymentAmount.toLocaleString('en-IN', {minimumFractionDigits: 2, maximumFractionDigits: 2})} as received?`)) {
                return;
            }
            
            try {
                const formData = new FormData();
                formData.append('month_id', monthId);
                
                // Use admin endpoint if user is admin, otherwise use user endpoint
                {% if user.role == "admin" %}
                const endpoint = '/admin/monthly-payment/mark-received';
                {% else %}
                const endpoint = '/api/user/monthly-payment/mark-received';
                {% endif %}
                
                const response = await fetch(endpoint, {
                    method: 'POST',
                    headers: {
                        'Accept': 'application/json',
                        'X-Requested-With': 'XMLHttpRequest'
                    },
                    body: formData
                });
                
                {% if user.role == "admin" %}
                // Admin endpoint returns JSON for AJAX requests
                if (response.ok) {
                    const data = await response.json();
                    alert('Monthly payment marked as received successfully!');
                    location.reload();
                } else {
                    const data = await response.json();
                    alert('Error: ' + (data.detail || 'Failed to mark payment as received'));
                }
                {% else %}
                const data = await response.json();
                
                if (response.ok) {
                    alert('Monthly payment receipt marked successfully! Waiting for admin verification.');
                    location.reload();
                } else {
                    alert('Error: ' + (data.detail || 'Failed to mark payment as received'));
                }
                {% endif %}
            } catch (error) {
                alert('Error: ' + error.message);
            }
        });
    });

});

// Submit payment function
async function submitPayment() {
    const form = document.getElementById('payInstallmentForm');
    const formData = new FormData(form);
    
    // Validate payment date
    const paymentDate = formData.get('payment_date');
    if (!paymentDate) {
        alert('Payment date is required!');
        return;
    }
    
    try {
        const response = await fetch('/api/user/payments', {
            method: 'POST',
            body: formData
        });
        
        const data = await response.json();
        
        if (response.ok) {
            alert('Payment submitted successfully! Waiting for admin verification.');
            // Close modal
            const modal = bootstrap.Modal.getInstance(document.getElementById('payInstallmentModal'));
            modal.hide();
            // Reload page
            location.reload();
        } else {
            alert('Error: ' + (data.detail || 'Failed to submit payment'));
        }
    } catch (error) {
        alert('Error: ' + error.message);
    }
}

document.addEventListener('DOMContentLoaded', function() {
    // Editable columns functionality
    const editableCells = document.querySelectorAll('.editable');
    let currentEdit = null;

    editableCells.forEach(cell => {
        const valueSpan = cell.querySelector('.editable-value');
        const input = cell.querySelector('.editable-input');
        
        // Make cell clickable
        valueSpan.style.cursor = 'pointer';
        valueSpan.title = 'Click to edit';
        
        valueSpan.addEventListener('click', function(e) {
            e.stopPropagation();
            
            // Close any other open edits
            if (currentEdit && currentEdit !== cell) {
                cancelEdit(currentEdit);
            }
            
            // Open this edit
            valueSpan.classList.add('d-none');
            input.classList.remove('d-none');
            input.focus();
            if (input.tagName === 'INPUT') {
                input.select();
            }
            currentEdit = cell;
        });

        // Save on blur or Enter key
        input.addEventListener('blur', function() {
            saveEdit(cell);
        });

        input.addEventListener('keydown', function(e) {
            if (e.key === 'Enter') {
                e.preventDefault();
                saveEdit(cell);
            } else if (e.key === 'Escape') {
                e.preventDefault();
                cancelEdit(cell);
            }
        });
    });

    function cancelEdit(cell) {
        const valueSpan = cell.querySelector('.editable-value');
        const input = cell.querySelector('.editable-input');
        valueSpan.classList.remove('d-none');
        input.classList.add('d-none');
        // Reset input value
        if (input.tagName === 'INPUT') {
            input.value = valueSpan.textContent.replace('â‚¹', '').replace(/,/g, '');
        }
        currentEdit = null;
    }

    async function saveEdit(cell) {
        const field = cell.dataset.field;
        const monthId = parseInt(cell.dataset.monthId);
        const input = cell.querySelector('.editable-input');
        const valueSpan = cell.querySelector('.editable-value');
        const originalValue = valueSpan.textContent.trim();
        
        let newValue, endpoint, body;
        
        if (field === 'installment' || field === 'payment') {
            newValue = parseFloat(input.value);
            if (isNaN(newValue) || newValue < 0) {
                alert('Please enter a valid positive number');
                cancelEdit(cell);
                return;
            }
            endpoint = `/api/dashboard/month/${monthId}/${field}`;
            body = JSON.stringify({ amount: newValue });
        } else if (field === 'assign') {
            newValue = input.value;
            endpoint = `/api/dashboard/month/${monthId}/assign`;
            body = JSON.stringify({ username: newValue });
        }

        // Show loading
        valueSpan.textContent = 'Saving...';
        valueSpan.classList.remove('d-none');
        input.classList.add('d-none');

        try {
            const response = await fetch(endpoint, {
                method: 'PUT',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: body
            });

            const data = await response.json();
            
            if (response.ok) {
                // Update display
                if (field === 'installment' || field === 'payment') {
                    valueSpan.textContent = 'â‚¹' + newValue.toLocaleString('en-IN', {
                        minimumFractionDigits: 2,
                        maximumFractionDigits: 2
                    });
                } else if (field === 'assign') {
                    if (newValue) {
                        // Find the selected option text
                        const selectedOption = input.querySelector(`option[value="${newValue}"]`);
                        valueSpan.textContent = selectedOption ? selectedOption.textContent.split(' (')[0] : 'Not Assigned';
                    } else {
                        valueSpan.innerHTML = '<span class="text-muted">Not Assigned</span>';
                    }
                }
                currentEdit = null;
            } else {
                alert('Error: ' + (data.detail || 'Failed to update'));
                valueSpan.textContent = originalValue;
            }
        } catch (error) {
            alert('Error: ' + error.message);
            valueSpan.textContent = originalValue;
            cancelEdit(cell);
        }
    }

    // Close edit when clicking outside
    document.addEventListener('click', function(e) {
        if (currentEdit && !currentEdit.contains(e.target)) {
            saveEdit(currentEdit);
        }
    });
});
</script>
{% endblock %}

